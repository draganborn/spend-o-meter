<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f7fa;
        color: #333;
        transition: background 0.3s, color 0.3s;
      }
      body.dark {
        background-color: #1e1e1e;
        color: #f1f1f1;
      }
      .nav {
        display: flex;
        justify-content: center;
        background-color: #333;
        padding: 10px;
        text-align: center;
      }
      .nav button {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
      }
      .nav button.active,
      .nav button:hover {
        background-color: #007bff;
      }
      .tool-container {
        display: none;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .tool-container.active {
        display: block;
      }
      /* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä */
      .moneyPerMonth-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      body.dark .moneyPerMonth-container {
        background-color: #2d2d2d;
      }
      .moneyPerMonth-h1,
      .moneyPerMonth-h3 {
        text-align: center;
        color: inherit;
      }
      .moneyPerMonth-btn-theme {
        display: block;
        margin: 10px auto 20px auto;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .payment-entry {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .payment-entry input[type='text'],
      .payment-entry input[type='number'] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .payment-entry button {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px 12px;
      }
      .add-payment-btn {
        background-color: #6a06a7;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px;
        width: 100%;
        margin-bottom: 20px;
      }
      #moneyPerMonthResult {
        margin-top: 30px;
        padding: 20px;
        background-color: #e9f7ef;
        border-left: 5px solid #28a745;
        color: #155724;
        display: none;
      }
      body.dark #moneyPerMonthResult {
        background-color: #3c3c3c;
        border-left-color: #4caf50;
        color: #ddd;
      }
      canvas {
        margin-top: 20px;
      }

      /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è */
      .card-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .card {
        display: flex;
        flex-direction: column;
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      body.dark .card-container {
        background-color: #2d2d2d;
      }
      body.dark .card {
        background-color: #2d2d2d;
      }
      #productsContainer {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      
      }
      .input-group {
    margin-bottom: 10px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: stretch;
}
      .input-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .input-group input,
      .input-group select {
        /* width: 100%; */
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-group button {
        flex: 1;
        padding: 10px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        color: white;
      }
      .add-btn {
        background: #6a06a7;
        color: #212121;
      }
      .submit-btn {
        background: #28a745;
      }
      .back-btn {
        background: #007bff;
      }
      .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        line-height: 1;
        font-weight: bold;
        cursor: pointer;
        float: right;
        align-self: flex-end;
      }
      .result-container {
        background: #e8f5e9;
        border-left: 4px solid #2e7d32;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
      }
      body.dark .result-container {
        background: #3c3c3c;
        color: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <div class="nav">
      <div style="display: flex; justify-content: center; gap: 10px">
        <button id="navMoneyPerMonth" class="active">
          –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤
        </button>
        <button id="navProductCompare">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</button>
        <button id="navFuelCompare">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ê–ó–°</button>
      </div>
      <button id="themeToggle" class="moneyPerMonth-btn-theme">üåì</button>
    </div>

    <div id="moneyPerMonthTool" class="tool-container active">
      <div class="moneyPerMonth-container">
        <h1 class="moneyPerMonth-h1">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤</h1>
        <!-- <button id="themeToggle" class="moneyPerMonth-btn-theme">
          –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É
        </button> -->
        <form id="financeForm" class="moneyPerMonth-form">
          <label
            >–í—Å–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å—á–µ—Ç–µ:
            <input type="number" step="0.01" id="allMyMoney" value="81933" />
          </label>
          <h3 class="moneyPerMonth-h3">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:</h3>
          <div id="paymentsContainer">
            <!-- –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç –ø–æ–ª—è -->
          </div>
          <button type="button" class="add-payment-btn" id="addPaymentBtn">
            + –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂
          </button>
          <label
            >–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è:
            <input type="date" id="nextPayDate" />
          </label>
          <button type="submit">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        </form>
        <div id="moneyPerMonthResult"></div>
        <canvas id="expensesChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div id="productTool" class="tool-container">
      <div class="card-container">
        <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <form id="productForm">
          <div id="productsContainer"></div>
          <div class="btn-group">
            <button type="button" class="add-btn" id="addProductBtn">
              + –¢–æ–≤–∞—Ä
            </button>
            <button type="submit" class="submit-btn">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
          </div>
        </form>
        <div
          class="result-container"
          id="productResult"
          style="display: none"
        ></div>
      </div>
    </div>

    <div id="fuelTool" class="tool-container">
      <div class="card-container">
        <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ê–ó–°</h2>
        <form id="fuelForm">
          <div id="stationsContainer"></div>
          <div class="btn-group">
            <button type="button" class="add-btn" id="addStationBtn">
              + –ê–ó–°
            </button>
            <button type="submit" class="submit-btn">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
          </div>
        </form>
        <div
          class="result-container"
          id="fuelResult"
          style="display: none"
        ></div>
      </div>
    </div>

    <script>
      // --- –¢–µ–º—ã ---
      const currentTheme = localStorage.getItem('appTheme') || 'light';
      document.body.classList.add(currentTheme);
      if (currentTheme === 'dark') document.body.classList.remove('light');

      // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---
      const navMoney = document.getElementById('navMoneyPerMonth');
      const moneyTool = document.getElementById('moneyPerMonthTool');

      const navProduct = document.getElementById('navProductCompare');
      const navFuel = document.getElementById('navFuelCompare');
      const productTool = document.getElementById('productTool');
      const fuelTool = document.getElementById('fuelTool');

      function showTool(name) {
        document
          .querySelectorAll('.tool-container')
          .forEach(div => div.classList.remove('active'));
        document
          .querySelectorAll('.nav button')
          .forEach(btn => btn.classList.remove('active'));

        if (name === 'money') {
          moneyTool.classList.add('active');
          navMoney.classList.add('active');
        } else if (name === 'product') {
          productTool.classList.add('active');
          navProduct.classList.add('active');
        } else if (name === 'fuel') {
          fuelTool.classList.add('active');
          navFuel.classList.add('active');
        }
      }

      navMoney.onclick = () => showTool('money');
      navProduct.onclick = () => showTool('product');
      navFuel.onclick = () => showTool('fuel');

      // --- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ---
      const paymentsContainer = document.getElementById('paymentsContainer');
      const addPaymentBtn = document.getElementById('addPaymentBtn');
      const financeForm = document.getElementById('financeForm');
      const resultDiv = document.getElementById('moneyPerMonthResult');
      const ctx = document.getElementById('expensesChart').getContext('2d');
      const themeToggle = document.getElementById('themeToggle');
      let chart;
      let paymentId = 0;

      const initialPayments = [
        { name: '–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç', amount: 19900 },
        { name: '–ò–ø–æ—Ç–µ–∫–∞', amount: 18000 },
        { name: '–ö—Ä–µ–¥–∏—Ç–∫–∞', amount: 12000 },
      ];

      function createPaymentField(name = '', amount = '') {
        paymentId++;
        const div = document.createElement('div');
        div.className = 'payment-entry';
        div.dataset.id = paymentId;

        div.innerHTML = `
            <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${name}" required>
            <input type="number" step="0.01" placeholder="–°—É–º–º–∞" value="${amount}" required>
            <button type="button" title="–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂">‚àí</button>
          `;

        div
          .querySelector('button')
          .addEventListener('click', () => div.remove());

        paymentsContainer.appendChild(div);
      }

      addPaymentBtn.onclick = () => createPaymentField();
      initialPayments.forEach(p => createPaymentField(p.name, p.amount));

      themeToggle.onclick = () => {
        document.body.classList.toggle('light');
        document.body.classList.toggle('dark');
        const theme = document.body.classList.contains('dark')
          ? 'dark'
          : 'light';
        localStorage.setItem('appTheme', theme);
        if (chart) chart.destroy();
        financeForm.dispatchEvent(new Event('submit'));
      };

      financeForm.onsubmit = e => {
        e.preventDefault();
        const allMoney =
          parseInt(document.getElementById('allMyMoney').value) || 0;
        const nextPayDate = new Date(
          document.getElementById('nextPayDate').value ||
            new Date().setMonth(new Date().getMonth() + 1)
        );
        const today = new Date();
        const daysLeft = Math.max(
          1,
          Math.ceil((nextPayDate - today) / (1000 * 60 * 60 * 24))
        );

        const payments = [...paymentsContainer.children].map(div => {
          return {
            name: div.querySelector("input[type='text']").value.trim(),
            value:
              parseInt(div.querySelector("input[type='number']").value) || 0,
          };
        });

        const total = payments.reduce((sum, p) => sum + p.value, 0);
        const free = allMoney - total;
        const perDay = free > 0 ? Math.floor(free / daysLeft) : 0;

        let html = `<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –≤—Å–µ –¥–µ–Ω—å–≥–∏: <strong>${allMoney} ‚ÇΩ</strong></p>
            <p>–û–±—â–∞—è —Å—É–º–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: <strong>${total} ‚ÇΩ</strong></p>`;
        html +=
          free < 0
            ? `<p style="color:red;">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–µ—Ä–Ω—É—Ç—å –Ω–∞ —Å—á—ë—Ç: <strong>${-free} ‚ÇΩ</strong></p>`
            : `<p>–°–≤–æ–±–æ–¥–Ω—ã—Ö –¥–µ–Ω–µ–≥: <strong>${free} ‚ÇΩ</strong></p>
               <p>–ú–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ: <strong>${perDay} ‚ÇΩ/–¥–µ–Ω—å</strong> (–¥–æ ${nextPayDate.toLocaleDateString(
                'ru-RU'
              )}, ${daysLeft} –¥–Ω.)</p>`;

        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: payments.map(p => p.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
            datasets: [
              {
                label: '–†–∞—Å—Ö–æ–¥—ã',
                data: payments.map(p => p.value),
                backgroundColor: document.body.classList.contains('dark')
                  ? '#0056b3'
                  : '#007bff',
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: document.body.classList.contains('dark')
                    ? '#f1f1f1'
                    : '#333',
                },
              },
              x: {
                ticks: {
                  color: document.body.classList.contains('dark')
                    ? '#f1f1f1'
                    : '#333',
                },
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: document.body.classList.contains('dark')
                    ? '#f1f1f1'
                    : '#333',
                },
              },
            },
          },
        });
      };

      window.addEventListener('DOMContentLoaded', () => {
        financeForm.dispatchEvent(new Event('submit'));
      });

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
      let productId = 0;
      const productForm = document.getElementById('productForm');
      const addProductBtn = document.getElementById('addProductBtn');
      const productsContainer = document.getElementById('productsContainer');
      const productResult = document.getElementById('productResult');

      function addProduct(name = '', price = '', weight = '') {
        productId++;
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <button type="button" class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
            <div class="input-group">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" value="${name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            <div class="input-group">
              <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
              <input type="number" step="0.01"  value="${price}" placeholder="0.00" required>
            </div>
            <div class="input-group">
              <label>–í–µ—Å/–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
              <input type="number" step="0.01"  value="${weight}" placeholder="0.00" required>
            </div>
          `;
        div.querySelector('.delete-btn').onclick = () => div.remove();
        productsContainer.appendChild(div);
      }

      addProductBtn.onclick = () => addProduct();
      addProduct('–ú–æ–ª–æ–∫–æ', 90, 1);

      productForm.onsubmit = e => {
        e.preventDefault();
        const products = [...productsContainer.children]
          .map(div => {
            const inputs = div.querySelectorAll('input');
            return {
              name: inputs[0].value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
              price: parseFloat(inputs[1].value),
              weight: parseFloat(inputs[2].value),
            };
          })
          .filter(p => p.price > 0 && p.weight > 0);

        if (products.length < 2) {
          productResult.style.display = 'none';
          return alert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–∞ —Ç–æ–≤–∞—Ä–∞.');
        }

        products.sort((a, b) => a.price / a.weight - b.price / b.weight);
        const best = products[0];
        let result = `–í—ã–≥–æ–¥–Ω–µ–µ: <strong>${best.name}</strong> (${(
          best.price / best.weight
        ).toFixed(2)} ‚ÇΩ/–µ–¥.)<br><br>`;

        for (let i = 1; i < products.length; i++) {
          const diff =
            (products[i].price /
              products[i].weight /
              (best.price / best.weight) -
              1) *
            100;
          result += `${products[i].name}: –¥–æ—Ä–æ–∂–µ –Ω–∞ ${diff.toFixed(1)}%<br>`;
        }

        productResult.innerHTML = result;
        productResult.style.display = 'block';
      };

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ê–ó–°
      let stationId = 0;
      const fuelForm = document.getElementById('fuelForm');
      const addStationBtn = document.getElementById('addStationBtn');
      const stationsContainer = document.getElementById('stationsContainer');
      const fuelResult = document.getElementById('fuelResult');

      function addStation(
        type = '–ê–ò-92',
        price = '',
        discountType = 'none',
        cashback = '',
        fixed = ''
      ) {
        stationId++;
        const div = document.createElement('div');
        div.className = 'card';
        div.dataset.id = stationId;

        div.innerHTML = `
            <button type="button" class="delete-btn">√ó</button>
            <div class="input-group">
              <label>–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞</label>
              <select class="fuel-type">
                <option value="–ê–ò-92"${
                  type === '–ê–ò-92' ? ' selected' : ''
                }>–ê–ò-92</option>
                <option value="–ê–ò-95"${
                  type === '–ê–ò-95' ? ' selected' : ''
                }>–ê–ò-95</option>
                <option value="–ê–ò-98"${
                  type === '–ê–ò-98' ? ' selected' : ''
                }>–ê–ò-98</option>
                <option value="–î–¢"${
                  type === '–î–¢' ? ' selected' : ''
                }>–î–¢</option>
              </select>
            </div>
            <div class="input-group">
              <label>–¶–µ–Ω–∞ –∑–∞ –ª–∏—Ç—Ä (‚ÇΩ)</label>
              <input type="number" step="0.01"  class="fuel-price" value="${price}" required>
            </div>
            <div class="input-group">
              <label>–¢–∏–ø —Å–∫–∏–¥–∫–∏</label>
              <select class="discount-select">
                <option value="none"${
                  discountType === 'none' ? ' selected' : ''
                }>–ù–µ—Ç</option>
                <option value="cashback"${
                  discountType === 'cashback' ? ' selected' : ''
                }>–ö—ç—à–±—ç–∫ (%)</option>
                <option value="fixed"${
                  discountType === 'fixed' ? ' selected' : ''
                }>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è (‚ÇΩ)</option>
              </select>
            </div>
            <div class="input-group cashback-group" style="display: none;">
              <label>–ü—Ä–æ—Ü–µ–Ω—Ç –∫—ç—à–±—ç–∫–∞</label>
              <input type="number" step="0.01"  class="cashback-value" value="${cashback}">
            </div>
            <div class="input-group fixed-group" style="display: none;">
              <label>–°–∫–∏–¥–∫–∞ –≤ ‚ÇΩ</label>
              <input type="number" step="0.01"  class="fixed-value" value="${fixed}">
            </div>
          `;

        const discountSelect = div.querySelector('.discount-select');
        const cashbackGroup = div.querySelector('.cashback-group');
        const fixedGroup = div.querySelector('.fixed-group');

        function toggleDiscountFields() {
          const type = discountSelect.value;
          cashbackGroup.style.display = type === 'cashback' ? 'block' : 'none';
          fixedGroup.style.display = type === 'fixed' ? 'block' : 'none';
        }

        toggleDiscountFields();
        discountSelect.onchange = toggleDiscountFields;

        div.querySelector('.delete-btn').onclick = () => div.remove();
        stationsContainer.appendChild(div);
      }

      addStationBtn.onclick = () => addStation();
      addStation('–ê–ò-95', 49.5, 'cashback', 5);

      fuelForm.onsubmit = e => {
        e.preventDefault();
        const stations = [...stationsContainer.children]
          .map(div => {
            const type = div.querySelector('.fuel-type').value;
            const discountType = div.querySelector('.discount-select').value;
            const price = parseFloat(div.querySelector('.fuel-price').value); // —É–∂–µ –µ—Å—Ç—å
            const cashback =
              parseFloat(div.querySelector('.cashback-value')?.value) || 0;
            const fixed =
              parseFloat(div.querySelector('.fixed-value')?.value) || 0;
            let finalPrice = price;
            if (discountType === 'cashback')
              finalPrice = price * (1 - cashback / 100);
            else if (discountType === 'fixed') finalPrice = price - fixed;

            return { type, price, finalPrice, discountType, cashback, fixed };
          })
          .filter(s => s.price > 0);

        if (stations.length < 2) {
          fuelResult.style.display = 'none';
          return alert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–µ –ê–ó–°.');
        }

        stations.sort((a, b) => a.finalPrice - b.finalPrice);
        const best = stations[0];
        let result = `–í—ã–≥–æ–¥–Ω–µ–µ: <strong>${
          best.type
        }</strong> (${best.finalPrice.toFixed(2)} ‚ÇΩ/–ª)<br><br>`;

        for (let i = 1; i < stations.length; i++) {
          const diff = (stations[i].finalPrice / best.finalPrice - 1) * 100;
          result += `${stations[i].type}: –¥–æ—Ä–æ–∂–µ –Ω–∞ ${diff.toFixed(1)}%<br>`;
        }

        fuelResult.innerHTML = result;
        fuelResult.style.display = 'block';
      };
    </script>
  </body>
</html>
