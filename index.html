<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Финансовый помощник</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f7fa;
        color: #333;
        transition:
          background 0.3s,
          color 0.3s;
      }
      body.dark {
        background-color: #1e1e1e;
        color: #f1f1f1;
      }
      .nav {
        background-color: #333;
        padding: 10px;
        text-align: center;
      }
      .nav button {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
      }
      .nav button.active,
      .nav button:hover {
        background-color: #007bff;
      }
      .tool-container {
        display: none;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .tool-container.active {
        display: block;
      }
      /* Финансовый калькулятор */
      .moneyPerMonth-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      body.dark .moneyPerMonth-container {
        background-color: #2d2d2d;
      }
      .moneyPerMonth-h1,
      .moneyPerMonth-h3 {
        text-align: center;
        color: inherit;
      }
      .moneyPerMonth-btn-theme {
        display: block;
        margin: 10px auto 20px auto;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .payment-entry {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .payment-entry input[type='text'],
      .payment-entry input[type='number'] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .payment-entry button {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px 12px;
      }
      .add-payment-btn {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px;
        width: 100%;
        margin-bottom: 20px;
      }
      #moneyPerMonthResult {
        margin-top: 30px;
        padding: 20px;
        background-color: #e9f7ef;
        border-left: 5px solid #28a745;
        color: #155724;
        display: none;
      }
      body.dark #moneyPerMonthResult {
        background-color: #3c3c3c;
        border-left-color: #4caf50;
        color: #ddd;
      }
      canvas {
        margin-top: 20px;
      }

      /* Общие стили для сравнения */
      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      body.dark .card {
        background-color: #2d2d2d;
      }
      .input-group {
        margin-bottom: 10px;
      }
      .input-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .input-group input,
      .input-group select {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-group button {
        flex: 1;
        padding: 10px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        color: white;
      }
      .add-btn {
        background: #ffc107;
        color: #212121;
      }
      .submit-btn {
        background: #28a745;
      }
      .back-btn {
        background: #007bff;
      }
      .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        line-height: 1;
        font-weight: bold;
        cursor: pointer;
        float: right;
      }
      .result-container {
        background: #e8f5e9;
        border-left: 4px solid #2e7d32;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
      }
      body.dark .result-container {
        background: #3c3c3c;
        color: #f1f1f1;
      }
    </style>
  </head>
  <body>
    <div class="nav">
      <button id="navMoneyPerMonth" class="active">Калькулятор финансов</button>
      <button id="navComparison">Сравнение цен</button>
    </div>

    <div id="moneyPerMonthTool" class="tool-container active">
      <div class="moneyPerMonth-container">
        <h1 class="moneyPerMonth-h1">Калькулятор финансов</h1>
        <button id="themeToggle" class="moneyPerMonth-btn-theme">
          Переключить тему
        </button>
        <form id="financeForm" class="moneyPerMonth-form">
          <label
            >Все деньги на счете:
            <input type="number" step="0.01" id="allMyMoney" value="81933" />
          </label>
          <h3 class="moneyPerMonth-h3">Обязательные платежи:</h3>
          <div id="paymentsContainer">
            <!-- Скрипт создаст поля -->
          </div>
          <button type="button" class="add-payment-btn" id="addPaymentBtn">
            + Добавить платеж
          </button>
          <label
            >Дата следующего поступления:
            <input type="date" id="nextPayDate" />
          </label>
          <button type="submit">Рассчитать</button>
        </form>
        <div id="moneyPerMonthResult"></div>
        <canvas id="expensesChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div id="comparisonTool" class="tool-container">
      <div class="card">
        <h2>Сравнение товаров</h2>
        <form id="productForm">
          <div id="productsContainer"></div>
          <div class="btn-group">
            <button type="button" class="add-btn" id="addProductBtn">
              + Товар
            </button>
            <button type="submit" class="submit-btn">Сравнить</button>
          </div>
        </form>
        <div
          class="result-container"
          id="productResult"
          style="display: none"
        ></div>
      </div>

      <div class="card">
        <h2>Сравнение АЗС</h2>
        <form id="fuelForm">
          <div id="stationsContainer"></div>
          <div class="btn-group">
            <button type="button" class="add-btn" id="addStationBtn">
              + АЗС
            </button>
            <button type="submit" class="submit-btn">Сравнить</button>
          </div>
        </form>
        <div
          class="result-container"
          id="fuelResult"
          style="display: none"
        ></div>
      </div>
    </div>
    <script>
        // --- Темы ---
        const currentTheme = localStorage.getItem("appTheme") || "light";
        document.body.classList.add(currentTheme);
        if (currentTheme === "dark") document.body.classList.remove("light");

        // --- Переключение вкладок ---
        const navMoney = document.getElementById("navMoneyPerMonth");
        const navCompare = document.getElementById("navComparison");
        const moneyTool = document.getElementById("moneyPerMonthTool");
        const compareTool = document.getElementById("comparisonTool");

        navMoney.onclick = () => {
          moneyTool.classList.add("active");
          compareTool.classList.remove("active");
          navMoney.classList.add("active");
          navCompare.classList.remove("active");
        };

        navCompare.onclick = () => {
          compareTool.classList.add("active");
          moneyTool.classList.remove("active");
          navCompare.classList.add("active");
          navMoney.classList.remove("active");
        };

        // --- Финансовый калькулятор ---
        const paymentsContainer = document.getElementById("paymentsContainer");
        const addPaymentBtn = document.getElementById("addPaymentBtn");
        const financeForm = document.getElementById("financeForm");
        const resultDiv = document.getElementById("moneyPerMonthResult");
        const ctx = document.getElementById("expensesChart").getContext("2d");
        const themeToggle = document.getElementById("themeToggle");
        let chart;
        let paymentId = 0;

        const initialPayments = [
          { name: "Автокредит", amount: 19900 },
          { name: "Ипотека", amount: 18000 },
          { name: "Кредитка", amount: 12000 }
        ];

        function createPaymentField(name = "", amount = "") {
          paymentId++;
          const div = document.createElement("div");
          div.className = "payment-entry";
          div.dataset.id = paymentId;

          div.innerHTML = `
            <input type="text" placeholder="Название" value="${name}" required>
            <input type="number" step="0.01" placeholder="Сумма" value="${amount}" required>
            <button type="button" title="Удалить платеж">−</button>
          `;

          div.querySelector("button").addEventListener("click", () => div.remove());

          paymentsContainer.appendChild(div);
        }

        addPaymentBtn.onclick = () => createPaymentField();
        initialPayments.forEach(p => createPaymentField(p.name, p.amount));

        themeToggle.onclick = () => {
          document.body.classList.toggle("light");
          document.body.classList.toggle("dark");
          const theme = document.body.classList.contains("dark") ? "dark" : "light";
          localStorage.setItem("appTheme", theme);
          if (chart) chart.destroy();
          financeForm.dispatchEvent(new Event("submit"));
        };

        financeForm.onsubmit = e => {
          e.preventDefault();
          const allMoney = parseInt(document.getElementById("allMyMoney").value) || 0;
          const nextPayDate = new Date(document.getElementById("nextPayDate").value || new Date().setMonth(new Date().getMonth() + 1));
          const today = new Date();
          const daysLeft = Math.max(1, Math.ceil((nextPayDate - today) / (1000 * 60 * 60 * 24)));

          const payments = [...paymentsContainer.children].map(div => {
            return {
              name: div.querySelector("input[type='text']").value.trim(),
              value: parseInt(div.querySelector("input[type='number']").value) || 0
            };
          });

          const total = payments.reduce((sum, p) => sum + p.value, 0);
          const free = allMoney - total;
          const perDay = free > 0 ? Math.floor(free / daysLeft) : 0;

          let html = `<p>На сегодняшний день все деньги: <strong>${allMoney} ₽</strong></p>
            <p>Общая сумма обязательных платежей: <strong>${total} ₽</strong></p>`;
          html += free < 0
            ? `<p style="color:red;">Необходимо вернуть на счёт: <strong>${-free} ₽</strong></p>`
            : `<p>Свободных денег: <strong>${free} ₽</strong></p>
               <p>Можно тратить ежедневно: <strong>${perDay} ₽/день</strong> (до ${nextPayDate.toLocaleDateString('ru-RU')}, ${daysLeft} дн.)</p>`;

          resultDiv.innerHTML = html;
          resultDiv.style.display = "block";

          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: payments.map(p => p.name || "Без названия"),
              datasets: [{
                label: "Расходы",
                data: payments.map(p => p.value),
                backgroundColor: document.body.classList.contains("dark") ? '#0056b3' : '#007bff'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: document.body.classList.contains("dark") ? '#f1f1f1' : '#333' }
                },
                x: {
                  ticks: { color: document.body.classList.contains("dark") ? '#f1f1f1' : '#333' }
                }
              },
              plugins: {
                legend: {
                  labels: {
                    color: document.body.classList.contains("dark") ? '#f1f1f1' : '#333'
                  }
                }
              }
            }
          });
        };

        window.addEventListener("DOMContentLoaded", () => {
          financeForm.dispatchEvent(new Event("submit"));
        });

        // Сравнение товаров
        let productId = 0;
        const productForm = document.getElementById("productForm");
        const addProductBtn = document.getElementById("addProductBtn");
        const productsContainer = document.getElementById("productsContainer");
        const productResult = document.getElementById("productResult");

        function addProduct(name = "", price = "", weight = "") {
          productId++;
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <button type="button" class="delete-btn" title="Удалить">×</button>
            <div class="input-group">
              <label>Название</label>
              <input type="text" value="${name}" placeholder="Название">
            </div>
            <div class="input-group">
              <label>Цена (₽)</label>
              <input type="number" step="0.01"  value="${price}" placeholder="0.00" required>
            </div>
            <div class="input-group">
              <label>Вес/Количество</label>
              <input type="number" step="0.01"  value="${weight}" placeholder="0.00" required>
            </div>
          `;
          div.querySelector(".delete-btn").onclick = () => div.remove();
          productsContainer.appendChild(div);
        }

        addProductBtn.onclick = () => addProduct();
        addProduct("Молоко", 90, 1);

        productForm.onsubmit = e => {
          e.preventDefault();
          const products = [...productsContainer.children].map(div => {
            const inputs = div.querySelectorAll("input");
            return {
              name: inputs[0].value || "Без названия",
      price: parseFloat(inputs[1].value), // вместо parseInt
      weight: parseFloat(inputs[2].value), // вместо parseInt
             // price: parseFloat(inputs[1].value),
             // weight: parseFloat(inputs[2].value)
            };
          }).filter(p => p.price > 0 && p.weight > 0);

          if (products.length < 2) {
            productResult.style.display = "none";
            return alert("Добавьте минимум два товара.");
          }

          products.sort((a, b) => (a.price / a.weight) - (b.price / b.weight));
          const best = products[0];
          let result = `Выгоднее: <strong>${best.name}</strong> (${(best.price / best.weight).toFixed(2)} ₽/ед.)<br><br>`;

          for (let i = 1; i < products.length; i++) {
            const diff = ((products[i].price / products[i].weight) / (best.price / best.weight) - 1) * 100;
            result += `${products[i].name}: дороже на ${diff.toFixed(1)}%<br>`;
          }

          productResult.innerHTML = result;
          productResult.style.display = "block";
        };

        // Сравнение АЗС
        let stationId = 0;
        const fuelForm = document.getElementById("fuelForm");
        const addStationBtn = document.getElementById("addStationBtn");
        const stationsContainer = document.getElementById("stationsContainer");
        const fuelResult = document.getElementById("fuelResult");

        function addStation(type = "АИ-92", price = "", discountType = "none", cashback = "", fixed = "") {
          stationId++;
          const div = document.createElement("div");
          div.className = "card";
          div.dataset.id = stationId;

          div.innerHTML = `
            <button type="button" class="delete-btn">×</button>
            <div class="input-group">
              <label>Тип топлива</label>
              <select class="fuel-type">
                <option value="АИ-92"${type === "АИ-92" ? " selected" : ""}>АИ-92</option>
                <option value="АИ-95"${type === "АИ-95" ? " selected" : ""}>АИ-95</option>
                <option value="АИ-98"${type === "АИ-98" ? " selected" : ""}>АИ-98</option>
                <option value="ДТ"${type === "ДТ" ? " selected" : ""}>ДТ</option>
              </select>
            </div>
            <div class="input-group">
              <label>Цена за литр (₽)</label>
              <input type="number" step="0.01"  class="fuel-price" value="${price}" required>
            </div>
            <div class="input-group">
              <label>Тип скидки</label>
              <select class="discount-select">
                <option value="none"${discountType === "none" ? " selected" : ""}>Нет</option>
                <option value="cashback"${discountType === "cashback" ? " selected" : ""}>Кэшбэк (%)</option>
                <option value="fixed"${discountType === "fixed" ? " selected" : ""}>Фиксированная (₽)</option>
              </select>
            </div>
            <div class="input-group cashback-group" style="display: none;">
              <label>Процент кэшбэка</label>
              <input type="number" step="0.01"  class="cashback-value" value="${cashback}">
            </div>
            <div class="input-group fixed-group" style="display: none;">
              <label>Скидка в ₽</label>
              <input type="number" step="0.01"  class="fixed-value" value="${fixed}">
            </div>
          `;

          const discountSelect = div.querySelector(".discount-select");
          const cashbackGroup = div.querySelector(".cashback-group");
          const fixedGroup = div.querySelector(".fixed-group");

          function toggleDiscountFields() {
            const type = discountSelect.value;
            cashbackGroup.style.display = type === "cashback" ? "block" : "none";
            fixedGroup.style.display = type === "fixed" ? "block" : "none";
          }

          toggleDiscountFields();
          discountSelect.onchange = toggleDiscountFields;

          div.querySelector(".delete-btn").onclick = () => div.remove();
          stationsContainer.appendChild(div);
        }

        addStationBtn.onclick = () => addStation();
        addStation("АИ-95", 49.5, "cashback", 5);

        fuelForm.onsubmit = e => {
          e.preventDefault();
          const stations = [...stationsContainer.children].map(div => {
            const type = div.querySelector(".fuel-type").value;
            const discountType = div.querySelector(".discount-select").value;
      const price = parseFloat(div.querySelector(".fuel-price").value); // уже есть
      const cashback = parseFloat(div.querySelector(".cashback-value")?.value) || 0;
      const fixed = parseFloat(div.querySelector(".fixed-value")?.value) || 0;

           // const price = parseFloat(div.querySelector(".fuel-price").value);
           // const cashback = parseFloat(div.querySelector(".cashback-value")?.value) || 0;
           // const fixed = parseFloat(div.querySelector(".fixed-value")?.value) || 0;

            let finalPrice = price;
            if (discountType === "cashback") finalPrice = price * (1 - cashback / 100);
            else if (discountType === "fixed") finalPrice = price - fixed;

            return { type, price, finalPrice, discountType, cashback, fixed };
          }).filter(s => s.price > 0);

          if (stations.length < 2) {
            fuelResult.style.display = "none";
            return alert("Добавьте минимум две АЗС.");
          }

          stations.sort((a, b) => a.finalPrice - b.finalPrice);
          const best = stations[0];
          let result = `Выгоднее: <strong>${best.type}</strong> (${best.finalPrice.toFixed(2)} ₽/л)<br><br>`;

          for (let i = 1; i < stations.length; i++) {
            const diff = ((stations[i].finalPrice / best.finalPrice) - 1) * 100;
            result += `${stations[i].type}: дороже на ${diff.toFixed(1)}%<br>`;
          }

          fuelResult.innerHTML = result;
          fuelResult.style.display = "block";
        };
    </script>
  </body>
</html>
